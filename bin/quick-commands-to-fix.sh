#!/bin/bash

echo "QUICK COMMANDS TO FIX RESOURCE CREATION ISSUES"
echo "=============================================="

echo ""
echo "ISSUES TO FIX:"
echo "1. ❌ DateTime serialization error"
echo "2. ❌ Missing 'Id' field (field name mismatch)"
echo "3. ❌ Resource creation failing"

echo ""
echo "STEP 1: Fix resource type field name mapping"
echo "============================================="
echo ""
echo "# Delete current resource type"
echo "openstack metric resource-type delete blazar_lease"
echo ""
echo "# Create with correct field name (Id instead of id)"
echo "openstack metric resource-type create blazar_lease \\"
echo "  --attribute Id:string:true:max_length=255 \\"
echo "  --attribute name:string:false:max_length=255 \\"
echo "  --attribute start_date:string:false:max_length=255 \\"
echo "  --attribute end_date:string:false:max_length=255"

echo ""
echo "STEP 2: Verify resource type"
echo "============================"
echo ""
echo "openstack metric resource-type show blazar_lease"

echo ""
echo "STEP 3: Redeploy Ceilometer"
echo "==========================="
echo ""
echo "kubectl -n openstack delete deployment ceilometer-notification"
echo "sleep 15"
echo "/opt/genestack/bin/install-ceilometer.sh"
echo "kubectl -n openstack wait --for=condition=ready pod -l app=ceilometer-notification --timeout=300s"

echo ""
echo "STEP 4: Test the fix"
echo "==================="
echo ""
echo "openstack reservation lease create \\"
echo "  --reservation resource_type=physical:host,min=1,max=1,hypervisor_properties='[\">=\", \"\$vcpus\", \"2\"]' \\"
echo "  --start-date \"\$(date --date '+1 min' +\"%Y-%m-%d %H:%M\")\" \\"
echo "  --end-date \"\$(date --date '+20 min' +\"%Y-%m-%d %H:%M\")\" \\"
echo "  test-lease-field-mapping-fix"

echo ""
echo "STEP 5: Verify results"
echo "====================="
echo ""
echo "openstack metric resource list --type blazar_lease"
echo "openstack metric list | grep -i blazar"

echo ""
echo "EXPECTED RESULTS:"
echo "✅ No datetime serialization errors"
echo "✅ No missing 'Id' field errors"
echo "✅ Resources created successfully in Gnocchi"
echo "✅ Complete integration working end-to-end"