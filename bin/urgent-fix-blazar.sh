#!/bin/bash
set -e

echo "URGENT FIX: Deploy configuration changes immediately..."

echo ""
echo "CURRENT ERRORS:"
echo "1. ❌ 'Required field id not specified' - still using lease_id instead of id"
echo "2. ❌ 'No gnocchi definition for event type: lease.event.start_lease' - event types not recognized"

echo ""
echo "ROOT CAUSE:"
echo "The configuration changes are in the files but NOT deployed to the running Ceilometer pods."

echo ""
echo "IMMEDIATE ACTIONS REQUIRED:"
echo ""
echo "STEP 1: Fix the Gnocchi resource type (CRITICAL)"
echo "=============================================="
echo ""
echo "# Delete the existing resource type with wrong attributes"
echo "openstack metric resource-type delete blazar_lease"
echo ""
echo "# Create new resource type with correct 'id' attribute"
echo "openstack metric resource-type create blazar_lease \\"
echo "  --attribute id:string:true:max_length=255 \\"
echo "  --attribute name:string:true:max_length=255 \\"
echo "  --attribute start_date:string:false:max_length=255 \\"
echo "  --attribute end_date:string:false:max_length=255"

echo ""
echo "STEP 2: Force redeploy Ceilometer (CRITICAL)"
echo "==========================================="
echo ""
echo "# Delete all Ceilometer deployments"
echo "kubectl -n openstack delete deployment ceilometer-notification"
echo "kubectl -n openstack delete deployment ceilometer-central"
echo ""
echo "# Wait for cleanup"
echo "sleep 20"
echo ""
echo "# Redeploy Ceilometer with updated configuration"
echo "/opt/genestack/bin/install-ceilometer.sh"
echo ""
echo "# Wait for pods to be ready"
echo "kubectl -n openstack wait --for=condition=ready pod -l app=ceilometer-notification --timeout=300s"
echo "kubectl -n openstack wait --for=condition=ready pod -l app=ceilometer-central --timeout=300s"

echo ""
echo "STEP 3: Verify the fix"
echo "====================="
echo ""
echo "# Check resource type has correct attributes"
echo "openstack metric resource-type show blazar_lease"
echo ""
echo "# Test creating a lease"
echo "openstack reservation lease create \\"
echo "  --reservation resource_type=physical:host,min=1,max=1,hypervisor_properties='[\">=\", \"\$vcpus\", \"2\"]' \\"
echo "  --start-date \"\$(date --date '+1 min' +\"%Y-%m-%d %H:%M\")\" \\"
echo "  --end-date \"\$(date --date '+20 min' +\"%Y-%m-%d %H:%M\")\" \\"
echo "  test-lease-urgent-fix"
echo ""
echo "# Check for resources"
echo "openstack metric resource list --type blazar_lease"
echo ""
echo "# Check for metrics"
echo "openstack metric list | grep -i blazar"
echo ""
echo "# Monitor logs for success"
echo "kubectl -n openstack logs -f deploy/ceilometer-notification | grep -i blazar"

echo ""
echo "EXPECTED RESULTS AFTER FIX:"
echo "✅ No 'Required field id not specified' errors"
echo "✅ No 'No gnocchi definition for event type' errors"
echo "✅ Resources created successfully in Gnocchi"
echo "✅ Metrics stored and queryable"
echo "✅ Complete integration working"

echo ""
echo "⚠️  IMPORTANT: Run these commands immediately to fix the integration!"