#!/bin/bash
set -e

echo "FINAL FIX: Resource Creation Issues"
echo "==================================="

echo ""
echo "CURRENT ISSUES IDENTIFIED:"
echo "1. ❌ DateTime serialization error: datetime objects not JSON serializable"
echo "2. ❌ Missing 'Id' field: required key not provided @ data['Id']"
echo "3. ❌ Field name mismatch: resource type expects 'Id' but Ceilometer sends 'id'"

echo ""
echo "ROOT CAUSE:"
echo "The Ceilometer configuration is not properly handling datetime conversion"
echo "and the field name mapping between Ceilometer and Gnocchi is incorrect."

echo ""
echo "SOLUTION:"
echo "1. Fix the field name mapping to use 'Id' instead of 'id'"
echo "2. Ensure datetime fields are converted to strings"
echo "3. Update the resource type definition to match Ceilometer's expectations"

echo ""
echo "Step 1: Fix the resource type field name mapping"
echo "================================================"
echo ""
echo "# Delete current resource type"
echo "openstack metric resource-type delete blazar_lease"
echo ""
echo "# Create with correct field name (Id instead of id)"
echo "openstack metric resource-type create blazar_lease \\"
echo "  --attribute Id:string:true:max_length=255 \\"
echo "  --attribute name:string:false:max_length=255 \\"
echo "  --attribute start_date:string:false:max_length=255 \\"
echo "  --attribute end_date:string:false:max_length=255"

echo ""
echo "Step 2: Update Ceilometer configuration"
echo "======================================="
echo ""
echo "The configuration needs to be updated to:"
echo "1. Map 'Id' field correctly"
echo "2. Ensure datetime fields are converted to strings"
echo "3. Provide the 'Id' field in resource creation"

echo ""
echo "Step 3: Redeploy Ceilometer"
echo "==========================="
echo ""
echo "kubectl -n openstack delete deployment ceilometer-notification"
echo "sleep 15"
echo "/opt/genestack/bin/install-ceilometer.sh"
echo "kubectl -n openstack wait --for=condition=ready pod -l app=ceilometer-notification --timeout=300s"

echo ""
echo "Step 4: Test the fix"
echo "==================="
echo ""
echo "openstack reservation lease create \\"
echo "  --reservation resource_type=physical:host,min=1,max=1,hypervisor_properties='[\">=\", \"\$vcpus\", \"2\"]' \\"
echo "  --start-date \"\$(date --date '+1 min' +\"%Y-%m-%d %H:%M\")\" \\"
echo "  --end-date \"\$(date --date '+20 min' +\"%Y-%m-%d %H:%M\")\" \\"
echo "  test-lease-final-fix"

echo ""
echo "Step 5: Verify results"
echo "====================="
echo ""
echo "openstack metric resource list --type blazar_lease"
echo "openstack metric list | grep -i blazar"

echo ""
echo "EXPECTED RESULTS:"
echo "✅ No datetime serialization errors"
echo "✅ No missing 'Id' field errors"
echo "✅ Resources created successfully in Gnocchi"
echo "✅ Complete integration working end-to-end"