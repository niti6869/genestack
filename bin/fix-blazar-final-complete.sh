#!/bin/bash
set -e

echo "Complete fix for Blazar-Ceilometer-Gnocchi integration..."

echo ""
echo "ISSUES IDENTIFIED AND FIXED:"
echo "1. ✅ Event type recognition - added missing event types"
echo "2. ✅ Meter definitions - fixed missing fields"
echo "3. ✅ Resource ID mapping - changed lease_id to id"
echo "4. ✅ Attribute mapping - updated to use id field"

echo ""
echo "CURRENT CONFIGURATION:"
echo "✅ Resource type attributes: id, name, start_date, end_date"
echo "✅ Event types: lease.event.*, blazar.lease.*, lease.*"
echo "✅ Meter definitions: complete with all required fields"
echo "✅ Resource mapping: id: resource_metadata.lease_id"

echo ""
echo "STEP 1: Fix the Gnocchi resource type"
echo "====================================="
echo ""
echo "Delete existing resource type:"
echo "openstack metric resource-type delete blazar_lease"
echo ""
echo "Create new resource type with correct attributes:"
echo "openstack metric resource-type create blazar_lease \\"
echo "  --attribute id:string:true:max_length=255 \\"
echo "  --attribute name:string:true:max_length=255 \\"
echo "  --attribute start_date:string:false:max_length=255 \\"
echo "  --attribute end_date:string:false:max_length=255"

echo ""
echo "STEP 2: Redeploy Ceilometer with corrected configuration"
echo "======================================================="
echo ""
echo "Delete existing deployment:"
echo "kubectl -n openstack delete deployment ceilometer-notification"
echo ""
echo "Wait for cleanup:"
echo "sleep 15"
echo ""
echo "Redeploy Ceilometer:"
echo "/opt/genestack/bin/install-ceilometer.sh"
echo ""
echo "Wait for pods to be ready:"
echo "kubectl -n openstack wait --for=condition=ready pod -l app=ceilometer-notification --timeout=300s"

echo ""
echo "STEP 3: Test the integration"
echo "==========================="
echo ""
echo "Create a test lease:"
echo "openstack reservation lease create \\"
echo "  --reservation resource_type=physical:host,min=1,max=1,hypervisor_properties='[\">=\", \"\$vcpus\", \"2\"]' \\"
echo "  --start-date \"\$(date --date '+1 min' +\"%Y-%m-%d %H:%M\")\" \\"
echo "  --end-date \"\$(date --date '+20 min' +\"%Y-%m-%d %H:%M\")\" \\"
echo "  test-lease-final-fix"

echo ""
echo "Check for resources:"
echo "openstack metric resource list --type blazar_lease"

echo ""
echo "Check for metrics:"
echo "openstack metric list | grep -i blazar"

echo ""
echo "Monitor logs:"
echo "kubectl -n openstack logs -f deploy/ceilometer-notification | grep -i blazar"

echo ""
echo "EXPECTED RESULTS:"
echo "✅ No 'Required field id not specified' errors"
echo "✅ No 'No gnocchi definition for event type' errors"
echo "✅ No 'metric blazar.lease.* is not handled by Gnocchi' warnings"
echo "✅ Resources created in Gnocchi with correct attributes"
echo "✅ Metrics stored and queryable"
echo "✅ Complete end-to-end integration working"