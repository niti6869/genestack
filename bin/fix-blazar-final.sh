#!/bin/bash
set -e

echo "Final fix for Blazar-Ceilometer-Gnocchi integration..."

echo "Issues identified:"
echo "1. Resource type attributes are incomplete (missing id, project_id, user_id, status)"
echo "2. Configuration needs to be redeployed to apply the complete attributes"

echo ""
echo "The configuration file has the correct attributes:"
echo "- id: resource_metadata.lease_id"
echo "- name: resource_metadata.name"
echo "- project_id: resource_metadata.project_id"
echo "- user_id: resource_metadata.user_id"
echo "- start_date: resource_metadata.start_date"
echo "- end_date: resource_metadata.end_date"
echo "- status: resource_metadata.status"

echo ""
echo "But the deployed configuration is missing these attributes."
echo "This means the configuration was not properly deployed."

echo ""
echo "To fix this, you need to:"
echo "1. Run this script from the environment where kubectl is available"
echo "2. Or manually redeploy Ceilometer with the updated configuration"

echo ""
echo "Manual steps:"
echo "1. Delete the existing Ceilometer deployment:"
echo "   kubectl -n openstack delete deployment ceilometer-notification"
echo ""
echo "2. Wait for cleanup:"
echo "   sleep 15"
echo ""
echo "3. Redeploy Ceilometer:"
echo "   /opt/genestack/bin/install-ceilometer.sh"
echo ""
echo "4. Wait for pods to be ready:"
echo "   kubectl -n openstack wait --for=condition=ready pod -l app=ceilometer-notification --timeout=300s"
echo ""
echo "5. Verify the fix:"
echo "   openstack metric resource-type show blazar_lease"
echo ""
echo "6. Test the integration:"
echo "   openstack reservation lease create --reservation resource_type=physical:host,min=1,max=1,hypervisor_properties='[\">=\", \"\$vcpus\", \"2\"]' --start-date \"\$(date --date '+1 min' +\"%Y-%m-%d %H:%M\")\" --end-date \"\$(date --date '+20 min' +\"%Y-%m-%d %H:%M\")\" test-lease"
echo ""
echo "7. Check for resources:"
echo "   openstack metric resource list --type blazar_lease"
echo ""
echo "8. Check for metrics:"
echo "   openstack metric list | grep -i blazar"