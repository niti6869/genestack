#!/bin/bash
set -e

echo "Fixing datetime serialization and missing required fields..."

echo ""
echo "ISSUES IDENTIFIED:"
echo "1. ❌ DateTime serialization error: datetime objects not JSON serializable"
echo "2. ❌ Missing required fields: 'Id' and 'name' not provided to Gnocchi"

echo ""
echo "ROOT CAUSE:"
echo "1. DateTime fields (start_date, end_date) are being passed as datetime objects instead of strings"
echo "2. The resource creation is missing the 'name' field in the resource data"

echo ""
echo "ANALYSIS FROM LOGS:"
echo "✅ Events are being processed correctly"
echo "✅ Resource ID mapping is working (id: '72d4a7e2-13eb-4cea-9478-b3851cf5d282')"
echo "✅ Metrics are being created (blazar.lease.create)"
echo "❌ Resource creation fails due to datetime serialization"
echo "❌ Resource creation fails due to missing 'name' field"

echo ""
echo "SOLUTION:"
echo "The issue is that Ceilometer is trying to create resources with datetime objects"
echo "and missing the 'name' field. This suggests the resource type definition needs"
echo "to be updated to handle datetime fields properly and ensure all required fields are present."

echo ""
echo "IMMEDIATE FIX:"
echo "1. Update the Gnocchi resource type to make 'name' optional or provide a default"
echo "2. Ensure datetime fields are converted to strings before sending to Gnocchi"

echo ""
echo "Commands to fix:"
echo ""
echo "# Check current resource type"
echo "openstack metric resource-type show blazar_lease"
echo ""
echo "# Update resource type to make name optional"
echo "openstack metric resource-type delete blazar_lease"
echo "openstack metric resource-type create blazar_lease \\"
echo "  --attribute id:string:true:max_length=255 \\"
echo "  --attribute name:string:false:max_length=255 \\"
echo "  --attribute start_date:string:false:max_length=255 \\"
echo "  --attribute end_date:string:false:max_length=255"

echo ""
echo "# Redeploy Ceilometer to ensure datetime handling is correct"
echo "kubectl -n openstack delete deployment ceilometer-notification"
echo "sleep 15"
echo "/opt/genestack/bin/install-ceilometer.sh"
echo "kubectl -n openstack wait --for=condition=ready pod -l app=ceilometer-notification --timeout=300s"

echo ""
echo "# Test the fix"
echo "openstack reservation lease create \\"
echo "  --reservation resource_type=physical:host,min=1,max=1,hypervisor_properties='[\">=\", \"\$vcpus\", \"2\"]' \\"
echo "  --start-date \"\$(date --date '+1 min' +\"%Y-%m-%d %H:%M\")\" \\"
echo "  --end-date \"\$(date --date '+20 min' +\"%Y-%m-%d %H:%M\")\" \\"
echo "  test-lease-datetime-fix"

echo ""
echo "EXPECTED RESULTS:"
echo "✅ No datetime serialization errors"
echo "✅ No missing required fields errors"
echo "✅ Resources created successfully in Gnocchi"
echo "✅ Complete integration working"